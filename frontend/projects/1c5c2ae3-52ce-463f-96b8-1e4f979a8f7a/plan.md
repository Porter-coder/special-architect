# 简单计算器应用技术实现规划书

## 1. 总体架构设计

### 1.1 架构概述

本计算器应用采用分层架构设计，将用户界面层、核心计算引擎层和数据持久化层进行清晰分离。这种架构模式确保了各层职责单一、耦合度低，便于独立开发、测试和维护。整体架构遵循MVC（模型-视图-控制器）设计范式的变体，其中模型层承载所有计算逻辑和数据处理，视图层负责用户界面的呈现和交互响应，控制器层作为两者之间的协调者处理用户输入并更新显示。

系统架构的核心原则包括：面向接口编程以实现组件的可替换性；事件驱动机制确保用户操作的即时响应；单例模式管理全局状态如历史记录和存储器；观察者模式实现计算结果与显示的自动同步。通过这种分层设计，计算器应用能够在保持代码整洁的同时，满足复杂的表达式求值需求和丰富的功能扩展要求。

### 1.2 设计模式应用

**策略模式**将应用于表达式解析和计算策略的管理，允许在不修改客户端代码的情况下切换不同的解析算法或精度策略。例如，当用户选择高精度模式时，系统可以动态切换浮点数处理策略。**工厂模式**用于创建不同类型的运算对象，每种运算（加法、减法、乘方、开方等）都有对应的工厂方法封装其创建逻辑，保持代码的开放封闭原则。

**状态模式**管理计算器的输入状态转换，包括初始状态、输入数字状态、输入运算符状态、等待第二操作数状态等。每种状态下对用户输入的处理逻辑被封装在对应的状态类中，状态转换清晰可控。**命令模式**为按钮点击和快捷键操作提供统一的执行接口，便于实现撤销功能和快捷键映射配置。**观察者模式**连接计算引擎与历史记录模块，当计算完成时自动通知历史模块记录结果。

### 1.3 技术选型决策

图形用户界面选择PyQt6作为开发框架，其跨平台特性能够完美支持Windows、macOS和Linux三大桌面操作系统。PyQt6提供丰富的GUI组件和完善的事件处理机制，其信号槽机制天然支持观察者模式，便于实现组件间的松耦合通信。相比其他GUI框架，PyQt6在界面美观度、响应速度和社区支持方面具有明显优势，且其商业友好的LGPL许可证允许本应用的自由分发。

表达式解析采用自研的递归下降分析器实现，而非依赖第三方数学解析库，这样可以完全控制语法规则的实现细节，便于后期扩展自定义函数和常量。数值计算直接使用Python内置的float类型（IEEE 754双精度），配合decimal模块处理需要高精度的特殊场景。历史记录的持久化采用JSON文件格式存储，兼顾数据可读性和解析效率。

---

## 2. 核心组件划分与职责

### 2.1 用户界面层（UI Layer）

**主窗口组件（MainWindow）** 作为应用的顶层容器，负责整体窗口管理、布局协调和生命周期控制。该组件初始化时创建所有子组件并建立连接，运行时协调各区域的消息传递，并在应用退出时负责资源清理和状态保存。主窗口还需处理系统级事件如窗口大小调整、焦点变化和会话结束通知。

**显示面板组件（DisplayPanel）** 专门负责计算器和历史结果的视觉呈现，采用双行显示设计：主行显示当前输入或计算结果，采用较大字号；副行显示表达式预览，采用较小灰色字体。该组件支持富文本渲染以实现科学计数法显示，并提供Markdown风格的格式化能力。显示面板还负责光标位置管理、输入验证反馈和错误信息展示。

**键盘面板组件（KeypadPanel）** 实现实体按钮网格布局，包含数字按钮区、运算符按钮区、功能按钮区和科学计算按钮区。每个按钮都绑定点击事件和快捷键，支持多种视觉状态（常规、悬停、按下、禁用）的渲染。键盘面板需响应主题切换事件，动态调整按钮颜色方案。

**历史记录面板组件（HistoryPanel）** 以可滚动列表形式展示历史计算记录，每条记录显示表达式和结果，支持点击重新计算和右键复制操作。该组件实现虚拟滚动技术以优化大量记录时的渲染性能，并提供搜索筛选功能便于用户快速定位历史条目。

**菜单与工具栏组件（MenuBar）** 提供应用级功能入口，包括文件菜单（新建、导出历史、退出）、编辑菜单（复制、粘贴、撤销）、视图菜单（主题切换、面板显示设置）、帮助菜单（使用说明、关于）等。工具栏提供常用操作的快捷图标入口，支持自定义配置。

### 2.2 业务逻辑层（Business Logic Layer）

**表达式引擎（ExpressionEngine）** 是计算器的核心处理器，负责将输入字符串解析为抽象语法树并执行求值。该引擎包含词法分析器、语法分析器和求值器三个子模块。词法分析器负责将字符流分解为词法单元流，识别数字常量、运算符、括号和科学常数。语法分析器采用递归下降算法，根据运算符优先级构建表达式树。求值器执行后序遍历计算，最终返回数值结果。

**运算器工厂（OperatorFactory）** 管理系统支持的所有运算类型，每种运算封装为独立的策略类。工厂提供运算对象的注册、查找和实例化接口，支持运行时动态添加新运算。预置运算包括：基础四则运算（Add、Subtract、Multiply、Divide）、取模运算（Modulo）、幂运算（Power）、根运算（Sqrt、Root）、对数运算（Log、Ln、Lg）、三角运算（Sin、Cos、Tan）及其反函数和双曲函数变体。

**存储器管理器（MemoryManager）** 实现计算器的存储功能，提供M+（存入存储器）、MR（调出存储器）、MC（清除存储器）和M-（从存储器减去）等操作。存储器采用双精度浮点数存储，支持NaN和Infinity等特殊值的表示。管理器还实现存储器与表达式的无缝集成，允许在表达式中直接引用存储器值。

**精度控制器（PrecisionController）** 管理计算过程中的数值精度和显示格式。该控制器定义全局精度参数，提供四舍五入、截断和科学计数法格式化方法。针对货币计算等特殊场景，精度控制器支持切换到十进制浮点数模式，避免二进制浮点带来的舍入误差。

### 2.3 数据持久化层（Data Persistence Layer）

**历史记录存储（HistoryStorage）** 负责历史数据的读写操作，采用循环缓冲区策略管理最多20条记录。存储模块将历史条目序列化为JSON格式，包含表达式字符串、计算结果、计算时间戳和操作类型标识。文件存储采用原子写入机制，防止写入中断导致数据损坏。每次计算完成后异步写入文件，避免阻塞用户界面响应。

**配置存储（ConfigStorage）** 管理应用配置数据的持久化，包括主题设置、快捷键映射、窗口状态和历史记录配置等。配置数据采用JSON格式存储在系统用户配置目录，遵循各操作系统的最佳实践（Windows注册表或INI文件、macOS的plist、Linux的XDG规范）。

**状态管理器（StateManager）** 在应用退出时捕获并保存当前状态，包括当前输入表达式、存储器值、显示面板内容和历史记录。应用启动时状态管理器自动恢复上次会话状态，确保用户工作的连续性。状态保存采用增量策略，仅存储变化的状态以优化IO性能。

---

## 3. 数据流与处理逻辑

### 3.1 输入处理流程

用户输入首先被UI层捕获，捕获源包括按钮点击、键盘按键和可能的语音输入。输入事件经过统一的预处理模块，该模块负责输入合法性检查、快捷键映射转换和输入缓冲管理。预处理后的有效输入被送入输入