# 实现计划

## 用户需求
创建一个简单的计算器应用

## 详细计划
# 简单计算器应用技术规划文档

## 一、总体架构与设计模式

### 1.1 架构设计概述

本计算器应用采用分层架构模式，将用户界面、业务逻辑和数据处理明确分离。整体架构分为四个主要层次：表现层负责用户交互和界面渲染，业务逻辑层处理计算器和表达式相关的核心算法，数据持久层管理内存存储和用户偏好设置，基础设施层提供跨平台兼容性和系统级功能支持。这种分层设计确保了各模块之间的低耦合高内聚，便于后续维护和功能扩展。

架构设计遵循MVC（Model-View-Controller）设计模式的变体，其中Model层封装所有计算逻辑和数据结构，View层处理界面呈现和用户输入接收，Controller层协调用户交互与业务逻辑之间的通信。采用这种模式的优势在于界面逻辑与业务逻辑完全分离，允许在不修改核心计算引擎的情况下更换用户界面主题或实现多种输入方式。

### 1.2 核心技术选型

用户界面框架选择Python标准库中的tkinter作为主要GUI实现方案。tkinter作为Python内置的标准GUI库，具有无需额外安装、跨平台兼容性极佳、文档资源丰富等优势。其性能表现满足本应用对响应时间的要求，能够实现100毫秒以内的输入响应延迟。tkinter的ttk模块提供现代化的界面组件样式，可通过ttk.Style定制按钮和显示区域的外观，达到专业计算器的视觉标准。

对于表达式解析和计算引擎，采用自定义实现而非第三方数学库。这一决策基于以下考量：计算器的表达式解析具有独特的语法规则和运算符优先级要求，通用数学库难以满足"实时预览"和"连续运算"等特定需求。自定义实现可精确控制计算过程中的每个步骤，便于实现错误检测、精度控制和用户体验优化。内部数值计算使用Python的decimal模块处理需要高精度的场景，float类型处理常规运算以平衡性能和精度需求。

### 1.3 设计模式应用

策略模式应用于表达式计算引擎，允许灵活切换不同的解析算法和计算策略。考虑到未来可能需要支持更多运算符或特殊的计算规则，这种设计使扩展变得简单。具体的算符优先算法或调度场算法可在运行时动态配置，界面层无需关心底层实现细节。

状态模式管理计算器的各种工作状态，包括正常输入状态、错误状态、内存操作状态等。每种状态对应不同的输入处理逻辑和行为约束，状态转换规则清晰定义在状态机中。这种设计使错误处理和状态恢复的实现更加系统化，避免了在各个输入处理函数中散布条件判断代码。

观察者模式用于实现界面组件与数据模型之间的同步。当表达式内容或计算结果发生变化时，所有依赖该数据的界面元素自动获得通知并刷新显示。这种机制支持主要显示区和辅助显示区的内容联动，以及内存状态指示器的实时更新。

## 二、关键组件及其职责

### 2.1 表现层组件

主窗口组件（MainWindow）作为应用的顶层容器，负责管理整个界面的布局和生命周期。该组件初始化时创建所有子组件并组织其空间位置，运行时处理窗口大小调整事件以实现响应式布局，同时协调各组件之间的焦点传递和键盘事件分发。主窗口还负责应用级的事件处理，如窗口关闭时的资源清理和用户偏好保存。

显示面板组件（DisplayPanel）封装所有与数值显示相关的界面元素。主要显示区采用大字体显示当前输入或计算结果，支持自动缩放以适应不同长度的数值。辅助显示区以较小字体显示完整表达式或内存状态，为用户提供输入确认和上下文参考。显示面板提供内容更新接口，接收来自控制器的新内容并触发界面重绘，同时实现光标移动和文本选择等编辑功能。

按钮矩阵组件（ButtonMatrix）组织计算器的所有物理按键。数字键区以网格形式排列0-9数字按钮，小数点和正负号等辅助数字键临近放置。运算符键区按照功能分组，加减乘除等基础运算符与百分比、开方等扩展运算符视觉上明显区分。等号键采用更大的尺寸和突出的颜色以标识其重要性。按钮组件封装点击事件处理，提供视觉反馈效果（如按下时的颜色变化），并支持禁用状态管理。

### 2.2 业务逻辑层组件

表达式管理器（ExpressionManager）负责管理和操作用户输入的表达式字符串。该组件维护当前表达式的内部表示，支持在末尾追加字符、在末尾删除字符、清空全部等核心操作。表达式以动态字符串形式存储，提供O(1)时间复杂度的尾部操作效率。组件还负责检测表达式长度是否超出限制（建议200字符上限），并在超出时拒绝继续输入。表达式管理器还维护撤销栈，支持实现单步撤销功能。

计算引擎（CalculatorEngine）是应用的核心计算组件，负责将表达式字符串解析并计算为最终结果。该组件实现完整的表达式解析算法，支持加减乘除、括号、幂运算、开方、百分比、倒数等多种运算符。解析过程采用算符优先算法或调度场算法，正确处理运算符优先级和括号嵌套（支持至少10层深度嵌套）。计算引擎在解析过程中实时计算中间值并返回预览结果，支持用户输入过程中的实时反馈。组件内部维护错误状态枚举，包含正常状态、除零错误、语法错误、括号不匹配错误、上溢错误、下溢错误等，错误信息以结构化形式返回供界面层展示。

内存管理器（MemoryManager）实现计算器的记忆功能，提供四个独立的内存存储单元。每个存储单元可保存一个数值，支持存储当前值（M+）、从存储值中减去当前值（M-）、调用存储值（MR）、清除单个存储值（M?）以及清除全部存储值（MC）等操作。内存管理器维护所有存储单元的当前状态，提供批量查询接口供界面显示内存使用情况。该组件还处理内存操作的持久化，允许在应用重启后恢复内存状态。

输入协调器（InputCoordinator）作为表现层和业务逻辑层之间的适配层，统一处理来自按钮点击和键盘输入的事件。该组件分析输入内容，判断是数字、运算符、功能键还是编辑键，并将不同类型的输入路由到相应的处理逻辑。输入协调器实现连续运算符替换逻辑，即用户在不按等号的情况下连续输入运算符时，自动将前一个运算符替换为新输入的运算符。该组件还负责管理输入焦点在表达式中的位置，支持方向键移动光标进行编辑。

### 2.3 数据结构定义

表达式节点类（ExpressionNode）构成表达式解析的抽象语法树节点。节点类型包括数值节点、运算符节点和括号节点。数值节点存储具体的数值（整数或浮点数）及其表示格式信息，运算符节点存储运算符类型和优先级，括号节点表示括号的嵌套关系。节点之间通过父子关系链接，形成完整的表达式树结构。每个节点提供计算接口，支持自底向上或自顶向下的计算策略。

错误状态枚举（ErrorStatus）定义计算器可能遇到的所有错误类型。枚举值包括NONE（正常）、DIVISION_BY_ZERO（除零错误）、SYNTAX_ERROR（语法错误）、MISMATCHED_BRACKETS（括号不匹配）、OVERFLOW（上溢）、UNDERFLOW（下溢）、INPUT_OVERFLOW（输入过长）。每个枚举值关联一个用户友好的错误描述信息，支持多语言扩展。

计算结果类（CalculationResult）封装表达式计算的完整输出。结果对象包含数值结果（以字符串和数值两种形式存储）、错误状态、是否需要清空输入等标志位、以及预览模式标识。该设计使界面层可以统一处理各种计算输出，无需关心底层的计算细节。

## 三、数据流与处理逻辑

### 3.1 输入处理流程

用户输入事件（按钮点击或键盘按键）首先到达输入协调器组件。输入协调器对输入内容进行分类，区分数字输入、运算符输入、功能键输入和编辑键输入。数字输入直接传递给表达式管理器追加到当前表达式末尾，同时触发预览计算（如果当前表达式完整）。运算符输入根据当前上下文决定是追加新
