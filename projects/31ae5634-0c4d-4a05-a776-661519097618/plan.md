# 实现计划

## 用户需求
简单的计算器


## 详细计划
# 简单计算器 - 技术实现规划

## 一、整体架构与设计模式

### 1.1 架构风格选择

本项目采用**分层架构（Layered Architecture）**结合**模型-视图-控制器（MVC）**设计模式，将用户界面、业务逻辑和数据处理明确分离。这种架构风格能够确保各层职责单一，便于维护和扩展，同时支持未来向不同平台移植核心计算引擎。

整体架构分为四个核心层次：**表现层**负责用户交互和界面展示，**应用层**协调各组件通信和控制流程，**业务逻辑层**承载核心计算和表达式处理功能，**数据层**管理状态存储和历史记录。各层次之间通过明确定义的接口进行通信，避免直接依赖，实现高内聚低耦合的设计目标。

### 1.2 核心设计模式

**策略模式（Strategy Pattern）**将用于处理不同的运算策略。每种运算（加、减、乘、除、幂、根等）封装为独立的策略类，通过统一的运算接口调用。这使得新增运算类型时无需修改现有代码，符合开闭原则。策略模式配合**工厂模式**使用，通过运算工厂根据运算符创建对应的运算实例，实现运算逻辑的集中管理和动态扩展。

**状态模式（State Pattern）**管理计算器的输入状态转换。计算器在不同状态下对同一输入的处理方式不同：初始状态接收首个操作数、输入状态累积数字和运算符、运算后状态等待新操作数开始。状态模式将这些状态行为封装在独立的状态类中，使状态转换逻辑清晰可维护。

**命令模式（Command Pattern）**实现撤销/重做功能。每个用户操作被封装为命令对象，存储在历史命令栈中。执行命令时将命令压入执行栈，撤销时从执行栈弹出并反向执行，同时压入撤销栈支持重做。这种设计将操作发起者与操作执行者解耦，便于扩展新的操作类型。

**观察者模式（Observer Pattern）**实现界面与数据的多向同步。当表达式树、显示值或历史记录发生变化时，注册的观察者（显示组件、历史面板等）自动更新，无需在业务逻辑中直接调用界面刷新代码。

### 1.3 模块划分

项目按功能划分为六个主要模块：**gui模块**处理所有用户界面相关功能，**core模块**承载核心计算引擎和表达式解析，**history模块**管理计算历史和记忆功能，**keyboard模块**处理键盘和手势输入，**theme模块**管理系统主题和样式，**accessibility模块**提供无障碍支持。各模块独立开发，通过约定接口集成，降低模块间耦合度。

---

## 二、关键组件与职责

### 2.1 表现层组件

**主窗口组件（MainWindow）**作为应用入口和容器，负责初始化各子组件并管理整体布局。主窗口监听系统主题变化事件，通知子组件同步切换；处理窗口大小调整事件，触发响应式布局重新计算；协调各模块的初始化顺序，确保依赖关系正确。

**显示面板组件（DisplayPanel）**负责数学表达式的可视化呈现。采用双行显示设计：上行以格式化文本展示完整表达式，支持运算符和括号的语法高亮；下行显示当前输入或计算结果，支持科学计数法表示超出范围的大数。显示面板监听表达式变化事件，自动滚动到光标位置；当输入超出可视区域时，支持平滑滚动和缩放查看。

**数字键盘组件（NumberPad）**实现3×4或4×3布局的数字按钮矩阵。每个按钮响应触摸和鼠标点击，触发数字输入事件；按钮支持多种尺寸和排列方式的主题定制；提供视觉反馈（按下态、禁用态、错误态）。数字键盘监听主题变化事件，同步更新按钮颜色和字体样式。

**功能键盘组件（FunctionPad）**组织运算符按钮和功能按钮。运算符区域包含基本四则运算和高级运算（幂、根、百分、取余），功能区域包含等号、清除、记忆操作和撤销重做。按钮按功能分组，采用不同视觉样式区分；长按运算符时显示工具提示，说明功能用法和示例。

**历史面板组件（HistoryPanel）**展示计算历史记录和记忆存储器状态。采用可折叠设计节省屏幕空间，支持快速点击历史条目将表达式或结果填入当前输入。历史记录按会话分组，支持搜索和筛选；提供清空历史和导出历史功能。

### 2.2 业务逻辑层组件

**表达式解析器（ExpressionParser）**是将用户输入的中缀表达式转换为抽象语法树的核心组件。采用递归下降解析法处理运算优先级，通过运算符优先级表和括号匹配实现正确的运算顺序。解析器输出语法错误（如不完整表达式、括号不匹配）和语义错误（如除零、负数开方），为用户提供精确的错误位置和原因说明。

**中缀转后缀转换器（InfixToPostfixConverter）**使用调度场算法将中缀表达式转换为后缀表达式。转换过程中维护运算符栈和输出队列，根据运算符优先级和左结合性规则正确处理连续运算符的情况。转换器输出后缀表达式队列，供求值器进一步处理。

**后缀表达式求值器（PostfixEvaluator）**使用操作数栈对后缀表达式进行求值。遍历后缀表达式队列，遇到操作数压栈，遇到运算符弹出相应数量的操作数执行运算，将结果压回栈中。求值器处理浮点运算的精度控制，按需求返回指定小数位数的结果或科学计数法表示。

**运算策略工厂（OperationStrategyFactory）**根据运算符标识创建对应的运算策略实例。工厂维护运算符到策略类的映射关系，支持运行时注册新的运算类型。每种运算策略实现统一的运算接口，接受操作数列表和精度参数，返回计算结果和可能的错误信息。

**精度控制器（PrecisionController）**管理浮点数运算的精度处理。实现四舍五入到指定小数位数的功能，处理浮点数精度丢失问题（如0.1+0.2不等于0.3），提供科学计数法和普通表示法的自动切换逻辑。

### 2.3 数据管理层组件

**输入缓冲区（InputBuffer）**管理当前输入的字符串序列。提供字符追加、删除、插入和清空操作；支持光标位置移动和范围选择；实现输入内容的序列化/反序列化，支持应用状态保存和恢复。缓冲区监听输入变化事件，通知表达式解析器进行增量解析。

**历史记录管理器（HistoryManager）**使用循环缓冲区存储最近计算历史。实现历史记录的添加、查询、删除和清空操作；支持按时间范围、表达式内容等条件筛选；提供历史数据的持久化存储（本地文件或数据库）；维护历史统计信息（如常用运算、最常使用功能）。

**记忆存储器（MemoryStore）**实现计算器的M+/M-/MR/MC功能。记忆存储器维护一个当前记忆值，支持累加当前显示值到记忆值、从记忆值减去当前显示值、读取记忆值到当前输入、清空记忆值等操作。提供记忆值变更事件通知，更新界面显示。

**状态管理器（StateManager）**管理计算器的整体状态快照。支持保存当前状态（表达式、输入缓冲区、历史、记忆值）到内部栈，支持恢复到之前保存的状态，实现跨会话的状态恢复。状态变更通过观察者模式通知相关组件。

### 2.4 输入处理层组件

**键盘输入处理器（KeyboardInputHandler）**监听物理键盘事件，将按键映射为计算器操作。支持数字键0-9输入数字和小数点，支持运算符键（+、-、*、/、^等）输入运算符号，支持功能
