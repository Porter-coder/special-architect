# 计算器应用技术实现计划

## 一、总体架构与设计模式

### 1.1 架构概述

本计算器应用采用分层架构设计，将用户界面层、业务逻辑层和数据持久层进行清晰分离。这种分层架构的优势在于各层之间耦合度低，便于独立开发、测试和维护，同时支持未来功能扩展和技术升级。用户界面层负责图形渲染和用户交互处理，业务逻辑层承担核心计算引擎和表达式解析职责，数据持久层则管理计算历史记录的存储与检索。

整体架构遵循MVC（Model-View-Controller）设计模式的变体，其中Model层对应计算引擎和表达式处理器，View层对应图形用户界面，Controller层作为两者之间的中介，协调用户输入到计算结果的完整流程。这种设计模式在桌面应用开发中经过广泛验证，能够有效组织代码结构并提升可维护性。

### 1.2 核心设计模式

**策略模式**将应用于计算算法的实现，使不同运算类型（加、减、乘、除）可以灵活替换和扩展。当需要添加模运算、幂运算等新功能时，只需实现统一的运算接口即可，无需修改现有计算逻辑。这种设计符合开闭原则，使系统具备良好的可扩展性。

**状态模式**用于管理输入状态机，识别用户输入序列的各个阶段——初始状态、数字输入状态、运算符输入状态、小数点输入状态等。每种状态对应特定的行为规则和转换条件，通过状态对象封装这些逻辑可以避免复杂的条件分支代码，使状态管理更加清晰和易于维护。

**观察者模式**将应用于界面与计算引擎之间的通信机制。当计算结果发生变化或历史记录更新时，界面组件能够自动接收通知并刷新显示内容。这种松耦合的通信方式便于界面模块的独立测试和替换，也有助于未来支持多窗口或剪贴板同步等扩展功能。

## 二、关键组件及其职责

### 2.1 用户界面层组件

**主窗口组件（MainWindow）** 担任应用入口和容器角色，负责创建和管理所有界面元素的层级关系。该组件初始化时设置窗口标题、尺寸策略和布局约束，并在应用生命周期内协调各子组件的通信。主窗口还需处理应用级别的事件，如窗口关闭、焦点切换等系统消息。

**显示面板组件（DisplayPanel）** 承担结果展示的核心职责，维护当前输入表达式和计算结果两行文本的显示。该组件需要处理长文本的自动缩放和滚动，确保输入内容超出显示区域时仍可被用户完整查看。显示面板还应支持主题切换，能够根据系统设置或用户偏好调整字体、颜色等视觉属性。

**输入面板组件（InputPanel）** 是用户交互的主要区域，采用网格布局组织所有按钮。组件内部将按钮按功能分区管理：数字键区（0-9和小数点）、运算符区（+、-、×、÷）、功能键区（等号、清除、括号等）。每个按钮在创建时绑定对应的事件处理器，支持点击和键盘快捷键两种触发方式。

**历史记录面板（HistoryPanel）** 以列表形式展示历史计算记录，支持滚动浏览和点击回溯。用户点击历史条目时，系统自动将该表达式的结果填入输入区域，支持连续计算场景。历史记录采用虚拟滚动技术优化大数据量显示性能，仅渲染可视区域内的列表项。

### 2.2 业务逻辑层组件

**表达式解析器（ExpressionParser）** 是计算引擎的核心组件，负责将中缀表达式转换为内部可处理的表示形式。该组件实现调度场算法（Shunting Yard Algorithm），将中缀表达式转换为后缀表达式（逆波兰表示），同时处理运算符优先级和括号嵌套逻辑。解析过程需要对输入字符串进行词法分析，识别数字、运算符和括号等语法单元。

**计算求值器（Evaluator）** 接收后缀表达式并执行实际计算操作。该组件基于栈结构实现，通过单次遍历即可完成表达式求值，时间复杂度为O(n)。求值器需要处理整数和浮点数的统一计算，考虑运算精度损失问题，采用高精度运算策略确保结果准确性。对于除法运算，求值器还需检测除零情况并抛出自定义异常。

**输入缓冲区管理器（InputBufferManager）** 维护当前输入序列的字符串状态，提供字符追加、删除、清空等基本操作。该组件实现输入验证逻辑，拒绝非数字和非允许运算符字符进入缓冲区。缓冲区设置最大长度限制（建议256字符），防止异常输入导致性能问题。管理器还负责维护编辑光标位置，支持在任意位置插入和删除字符。

**状态机控制器（StateMachineController）** 管理计算器的整体工作状态，包括就绪状态、输入状态、计算状态和错误状态。状态转换规则明确定义：就绪状态下用户输入数字后转入输入状态；输入状态下按运算符键后保持输入状态但记录运算符；按等号键后转入计算状态并显示结果；错误状态下任何有效输入都将重置为就绪状态。状态机使行为预测更加明确，简化了复杂交互逻辑的实现。

### 2.3 数据持久层组件

**历史记录存储器（HistoryStorage）** 负责计算历史数据的持久化管理，支持添加记录、查询记录和清空历史等操作。存储器采用文件存储方案，使用JSON格式保存历史数据，便于人工查阅和程序解析。存储路径选择操作系统推荐的配置目录，确保不同平台下的路径兼容性。存储器还需实现容量限制和自动清理机制，防止历史文件无限增长。

**配置存储器（ConfigStorage）** 管理应用配置信息，包括窗口尺寸、主题模式、快捷键绑定等用户偏好设置。配置数据采用分层结构组织，支持默认值回退和配置迁移。存储器在应用启动时加载配置并应用到各组件，在设置变更时即时保存最新值。

## 三、数据流与处理逻辑

### 3.1 主数据流路径

数据流从用户输入开始，经过多层处理最终到达结果显示。完整的数据处理路径如下：用户通过键盘或鼠标产生输入信号，事件首先到达输入面板的事件处理模块；事件处理模块根据输入类型调用输入缓冲区管理器的相应方法；缓冲区管理器更新内部状态并触发状态变更通知；界面显示组件响应状态变更，更新输入内容展示；如果输入导致计算条件满足（如按下等号），主控制器发起计算流程；表达式解析器从缓冲区获取当前表达式，进行语法分析和转换；计算求值器执行实际运算并将结果返回；主控制器更新显示内容和历史记录；最终用户看到计算结果。

整个数据流是单向流动的，每一层只与其直接相邻的层级交互，这种设计保证了数据流动的可追踪性和问题定位的便捷性。

### 3.2 表达式处理流程

表达式处理的详细流程分为五个阶段。**词法分析阶段**逐字符扫描输入字符串，识别数字序列（包括整数和小数部分）、运算符字符和括号符号。词法分析器需要处理连续运算符（如++）的非法情况，并正确识别小数点的位置和数量约束。**语法验证阶段**检查表达式的语法合法性，包括括号是否配对、表达式是否以合法字符开始和结束、是否存在连续运算符等非法模式。**中缀转后缀阶段**应用调度场算法，使用运算符栈和输出队列完成转换，同时处理运算符优先级和左结合性规则。**后缀求值阶段**遍历后缀表达式，使用操作数栈完成计算，每读取到一个运算符就从栈顶弹出所需数量的操作数，执行运算后将结果压回栈中。**结果处理阶段