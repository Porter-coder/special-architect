# 实现计划

## 用户需求
一个计算器软件


## 详细计划
# 计算器软件技术规划文档

## 一、总体架构设计

### 1.1 架构模式选择

本项目采用分层架构模式，结合MVC设计理念进行整体设计。该架构模式将应用划分为表现层、业务逻辑层、数据访问层三个主要层次，各层之间通过明确定义的接口进行通信，确保系统的可维护性、可扩展性和可测试性。表现层负责用户界面的渲染和交互处理，业务逻辑层承载核心计算引擎和数据处理逻辑，数据访问层负责历史记录、用户配置和记忆存储的持久化管理。

在具体实现中，表现层采用观察者模式监听业务逻辑层状态变化，实现界面的响应式更新。业务逻辑层内部采用策略模式支持不同计算模式的切换，如基本算术模式、科学计算模式、统计计算模式等。数据访问层采用仓储模式统一管理数据持久化操作，便于后续扩展或更换存储后端。

### 1.2 技术栈规划

前端界面选用Qt 6框架作为图形用户界面开发库，该框架具备优秀的跨平台特性，可在Windows、macOS、Linux三大桌面操作系统上提供一致的用户体验。Qt 6相比前代版本在性能、渲染效率和现代语言支持方面有明显提升，其信号槽机制非常适合处理计算器应用中的事件驱动场景。

后端计算引擎完全采用Python标准库实现，包括 fractions 模块处理精确分数运算、decimal 模块处理高精度浮点运算、math 和 cmath 模块提供基础数学函数。表达式解析采用自定义实现的递归下降解析器，结合逆波兰表示法完成复杂表达式的计算。

数据持久化采用SQLite数据库存储历史记录和用户配置，该数据库轻量级且无需独立服务器进程，非常适合桌面应用场景。JSON格式用于配置文件的读写，便于用户手动编辑和迁移设置。

### 1.3 项目目录结构

```
calculator/
├── src/
│   ├── __init__.py
│   ├── main.py                    # 程序入口点
│   ├── models/                    # 数据模型层
│   │   ├── __init__.py
│   │   ├── calculator_state.py    # 计算器状态模型
│   │   ├── memory.py              # 记忆存储模型
│   │   └── history.py             # 历史记录模型
│   ├── core/                      # 核心计算引擎
│   │   ├── __init__.py
│   │   ├── parser.py              # 表达式解析器
│   │   ├── evaluator.py           # 表达式求值器
│   │   ├── operations.py          # 基础运算实现
│   │   ├── scientific.py          # 科学计算函数
│   │   ├── statistics.py          # 统计计算函数
│   │   └── converter.py           # 进制转换器
│   ├── ui/                        # 用户界面层
│   │   ├── __init__.py
│   │   ├── main_window.py         # 主窗口
│   │   ├── display_widget.py      # 显示区域组件
│   │   ├── button_panel.py        # 按钮面板组件
│   │   ├── keyboard_handler.py    # 键盘输入处理器
│   │   └── theme_manager.py       # 主题管理
│   ├── data/                      # 数据访问层
│   │   ├── __init__.py
│   │   ├── database.py            # SQLite数据库操作
│   │   ├── repository.py          # 数据仓储
│   │   └── config_manager.py      # 配置管理
│   └── utils/                     # 工具模块
│       ├── __init__.py
│       ├── precision.py           # 精度控制工具
│       ├── cache.py               # 计算缓存机制
│       └── validators.py          # 输入验证工具
├── tests/                         # 测试目录
├── resources/                     # 资源文件
├── docs/                          # 文档
├── requirements.txt               # 依赖配置
└── README.md                      # 项目说明
```

---

## 二、核心组件职责

### 2.1 表现层组件

**主窗口组件（MainWindow）** 作为应用的核心容器，负责协调各界面组件的布局和交互。主窗口管理显示区域、按钮面板、菜单栏、工具栏等视觉元素的排列组合，处理窗口大小调整、最小化、最大化、关闭等系统级事件。主窗口还负责响应应用级别的快捷键，如Ctrl+N新建计算、Ctrl+H显示历史、Ctrl+M显示记忆面板等。

**显示组件（DisplayWidget）** 承担所有数值和表达式的展示功能。该组件分为主要结果显示区和表达式预览区两个部分，主要结果显示区采用大号字体高亮展示当前计算结果，表达式预览区以较小字体展示用户当前输入的完整表达式。显示组件支持多种数字格式的渲染，包括普通十进制、科学计数法、分数形式等，根据数值范围和用户设置自动切换显示格式。该组件还负责光标位置管理和选中高亮功能。

**按钮面板组件（ButtonPanel）** 实现所有计算器按钮的布局和交互响应。按钮按照功能分组排列：数字键区、运算符区、记忆功能区、科学计算区、统计计算区、进制转换区。每个按钮按下时触发相应的输入事件，按钮具有悬停、按压、禁用三种视觉状态，通过样式表实现主题适配。面板支持折叠操作，用户可根据需要隐藏科学计算或进制转换等功能区。

**键盘处理器（KeyboardHandler）** 统一管理所有键盘输入事件。该组件将物理按键映射为逻辑输入事件，支持数字、运算符、功能键的输入处理。键盘处理器实现按键防抖和长按检测，支持组合键如Shift+数字输入上档符号。方向键用于在历史记录中导航，Tab键实现输入区和按钮区之间的焦点切换。

**主题管理器（ThemeManager）** 提供界面皮肤和显示选项的集中管理。该组件维护浅色主题和深色主题的颜色配置，支持字体大小三级调节、数字分组显示开关、科学计数法阈值配置等选项。主题管理器响应系统级主题变化，支持跟随操作系统设置自动切换主题。

### 2.2 业务逻辑层组件

**表达式解析器（Parser）** 负责将用户输入的中缀表达式转换为内部可处理的抽象语法树。该解析器采用递归下降算法实现，通过词法分析阶段识别数字、运算符、函数名、括号等语法单元，语法分析阶段根据运算符优先级和结合性构建表达式树。解析器在词法分析阶段进行基本语法检查，识别非法字符、连续运算符、不匹配括号等语法错误。解析器还负责处理隐式乘法（如"2(3+4)"转换为"2*(3+4)"）和一元运算符（负号）的识别。

**表达式求值器（Evaluator）** 接收解析器生成的抽象语法树，执行实际的计算操作。求值器采用深度优先遍历算法递归计算每个子树的值，在计算过程中应用运算符优先级规则。求值器集成高精度计算模块，确保基本算术运算达到15位以上有效数字的科学计数法精度。求值器还实现计算结果缓存机制，对重复计算进行优化。

**基础运算模块（Operations）** 实现四则运算的具体算法。加法采用精确加法算法处理整数和小数，确保末尾零不丢失；减法通过补码运算处理负数结果；乘法采用Karatsuba或更高效的FFT乘法处理大数相乘；除法区分整数除法（返回商和余数）和浮点除法（返回精确商）。所有运算均实现溢出检测，超出64位整数范围时抛出溢出异常。

**科学计算模块（Scientific）** 提供超越函数的计算实现。三角函数支持角度制和弧度制两种输入模式，通过用户设置或函数后缀标识（如sin(π)表示弧度，sin°(30)表示角度）区分。指数和对
