# 实现计划

## 用户需求
创建一个简单的计算器应用

## 详细计划
# 简单计算器应用技术实施计划

## 一、整体架构与设计模式

### 1.1 架构风格选择

本项目采用分层架构模式中的MVC（Model-View-Controller）变体，结合模块化设计原则进行构建。整体架构分为三个主要层次：表现层负责用户界面的渲染与交互响应，业务逻辑层处理核心计算与表达式解析，数据持久层管理历史记录与用户偏好设置。这种分层架构的优势在于职责划分清晰，各层之间通过明确定义的接口进行通信，便于后续的功能扩展与维护。

在表现层与业务逻辑层之间，采用观察者模式实现数据绑定机制。当底层计算模型的数据发生变化时，自动通知界面进行更新，确保用户界面的实时性与一致性。业务逻辑层内部则采用策略模式处理不同的运算类型，使算术运算、函数运算、百分比运算等可以独立实现与测试，同时保持核心解析逻辑的稳定性。

### 1.2 核心设计模式应用

**策略模式**用于封装各类运算符的计算逻辑。每个运算符类型（加、减、乘、除、幂、模等）作为独立策略实现，运行时可根据输入动态选择计算策略。这种设计使得新增运算符类型时无需修改现有代码结构，只需添加新的策略类即可。

**状态模式**管理计算器的运行状态，包括空状态、输入状态、计算完成状态、错误状态等。不同状态下用户操作的响应方式有所差异，状态模式将状态转换逻辑封装在独立的状态类中，避免条件分支的过度膨胀。

**组合模式**处理表达式的树形结构表示。表达式中的每个操作数与运算符都可以视为表达式树的节点，复合表达式可以由简单表达式组合而成。这种表示方式为表达式求值提供了统一的处理接口，简化了递归求值算法的实现。

### 1.3 模块划分策略

应用按功能域划分为五个核心模块。输入处理模块负责按键事件的捕获与预处理，包括数字输入的拼接、小数点重复检测、运算符的连续输入限制等逻辑。表达式解析模块实现中缀表达式到抽象语法树的转换，是实现运算优先级控制的关键组件。计算引擎模块执行实际的算术运算，支持整数、浮点数的高精度计算。历史记录模块管理计算历史的存储与检索，提供本地持久化支持。界面渲染模块处理所有视觉元素的绘制与布局，适应不同主题与分辨率设置。

---

## 二、关键组件及其职责

### 2.1 输入处理组件

输入处理组件作为用户交互的第一入口，承担着按键事件的接收、验证与转换职责。该组件维护当前输入缓冲区的状态，包括当前输入的数字串、已输入的运算符序列、以及光标位置等信息。每次按键事件触发后，组件首先进行输入合法性校验，例如检测小数点的重复输入、运算符的连续输入等情况，对于非法输入产生相应的错误信号。

输入处理组件还需实现智能输入补全功能。当用户输入左括号后，系统可自动补全右括号并保持光标在括号内部；当用户输入百分号时，自动将当前数值除以100进行转换。这种智能补全体验需要与输入验证逻辑协同工作，确保在提供便利的同时不引入语法错误。

组件对外暴露标准化的输入接口，包括数字输入方法、运算符输入方法、功能键输入方法等。每个接口方法返回操作结果状态码，供调用方判断输入是否成功。输入缓冲区内容的获取通过只读属性实现，保证数据一致性不受外部意外修改。

### 2.2 表达式解析引擎

表达式解析引擎是计算器的核心组件，负责将用户输入的中缀表达式转换为可计算的内部表示形式。引擎采用递归下降解析与运算符优先级结合的方式实现，针对计算器的运算符集合设计了专用的语法分析器。解析过程分为词法分析与语法分析两个阶段，词法分析负责将字符流分解为记号序列，语法分析负责根据文法规则构建表达式树。

词法分析器识别六类记号：数值记号（整数、小数、科学计数法表示）、运算符记号（加减乘除幂模等）、括号记号、函数记号（平方根、对数等）、分隔符记号、以及结束标记。数值记号的解析需要处理前导零、尾随零、小数点位置等细节，确保数值表示的规范性与一致性。

语法分析器采用运算符优先级分析法处理运算顺序。首先建立完整的优先级对照表，括号具有最高优先级，幂运算次之，乘除模运算再次之，加减运算优先级最低。解析时维护运算符栈与输出队列，通过比较栈顶运算符与当前运算符的优先级决定移进或归约操作。括号的出现触发子表达式的独立解析，括号嵌套层数设置上限防止栈溢出攻击。

解析结果以抽象语法树的形式存储，每个内部节点代表运算符，叶子节点代表操作数。树形结构支持深度优先的后序遍历求值，确保每个子表达式先于父表达式计算。引擎还负责在解析过程中检测语法错误，如不完整的表达式、运算符缺失操作数、括号不匹配等，并将错误信息传递给上层组件处理。

### 2.3 高精度计算引擎

计算引擎负责执行表达式树节点的运算，生成最终计算结果。引擎采用Python的Decimal类型作为主要数值类型，配合getcontext()设置适当精度，以满足浮点数计算中的精度控制需求。Decimal类型提供精确的十进制运算，避免了二进制浮点数表示带来的精度损失，特别适合财务计算与科学计算场景。

对于除法运算，引擎预设小数位数上限与舍入模式。默认显示小数位数可根据用户设置调整，舍入规则采用银行家舍入法（ROUND_HALF_EVEN）作为标准配置。除不尽的情况下，引擎根据设置的精度进行截断或舍入，同时记录是否产生舍入误差的状态标志。

幂运算的实现需要特别注意负数底数的奇偶次幂区分。当底数为负且指数为非整数时，运算结果在实数范围内无定义，引擎应返回NaN（非数值）错误。平方根运算同样需要判断输入值是否非负，对于负数输入返回虚数结果或报错，具体行为可根据用户偏好设置。

引擎还需处理特殊数值情况，包括正无穷、负无穷、除零错误、以及数值溢出等。这些情况的出现应有明确的错误代码与用户友好的提示信息。计算过程中的中间结果采用高精度存储，仅在最终输出时进行精度转换，最大限度减少累积误差的影响。

### 2.4 历史记录管理器

历史记录管理器提供计算历史的存储、查询与持久化功能。管理器内部维护一个固定大小的循环缓冲区，用于存储最近的计算记录。每条记录包含原始输入表达式、计算结果、时间戳三个核心字段，格式化为可读字符串便于用户查看。

存储机制采用SQLite数据库实现轻量级持久化。数据库表设计包括主键ID、表达式文本、结果文本、创建时间戳四个字段，建立表达式文本的索引以支持快速检索。历史记录的保留数量设置上限，默认为50条，超出上限时自动删除最旧的记录。

管理器支持历史记录的按需复制操作。用户选中历史条目后，可通过快捷键或按钮将表达式或结果复制到剪贴板，用于后续计算或外部引用。批量操作功能允许用户一键清空历史记录，或导出历史记录为CSV格式文件。导出功能通过Python标准库中的csv模块实现，不依赖额外第三方库。

### 2.5 用户界面组件

用户界面采用响应式布局设计，主窗口由显示区域与按键区域两部分组成。显示区域位于窗口顶部，采用垂直分割布局，上方显示当前输入表达式（字体较小
