# 简单计算器应用 - 技术实现计划

## 一、总体架构与设计模式

### 1.1 架构概述

本计算器应用采用分层架构模式，将用户界面、表达式处理和计算逻辑分离，确保各模块之间低耦合、高内聚。整体架构分为三个核心层次：表现层负责用户交互，包括命令行界面或图形界面的渲染与输入处理；业务逻辑层承载核心计算功能，包括表达式解析、验证和求值；数据持久层管理历史记录的存储与检索。这种分层设计使得界面实现可以在不影响核心计算逻辑的情况下灵活替换，例如从命令行界面迁移至图形界面时，只需重写表现层模块。

### 1.2 设计模式应用

应用采用多种设计模式以确保代码的可维护性和可扩展性。首先，策略模式用于处理不同的运算操作，将加、减、乘、除等运算封装为独立的策略对象，便于新增运算符时不影响现有代码结构。其次，工厂模式用于创建不同类型的数值对象（整数、小数、分数），根据表达式中的数值格式动态选择合适的表示方式。此外，观察者模式可用于实现历史记录的自动更新机制，当计算完成时自动通知历史模块记录结果。模板方法模式则用于定义表达式解析的标准流程，具体的词法分析和语法分析步骤由子类实现或由组合对象协作完成。

### 1.3 模块关系图

表现层包含命令行界面（CLICalculator）或图形用户界面（GUICalculator），两者实现统一的接口规范。业务逻辑层由表达式解析器（ExpressionParser）、计算引擎（CalculatorEngine）和错误处理器（ErrorHandler）三个核心组件构成。数据持久层包含历史记录管理器（HistoryManager）和配置管理器（ConfigManager）。表现层通过调用业务逻辑层的统一接口与底层模块交互，向上屏蔽实现细节，确保用户界面的简洁性。

---

## 二、核心组件及其职责

### 2.1 表现层组件

命令行界面组件负责终端环境下的用户交互，其主要职责包括显示欢迎信息、提示用户输入、接收并解析用户命令、格式化输出计算结果和错误信息。该组件需要处理ANSI转义序列以实现跨平台的彩色输出支持，同时监听键盘事件以实现快捷键功能（如上下方向键浏览历史记录、Ctrl+C退出等）。界面组件应实现输入历史功能，在用户输入时维护一个本地历史缓冲区，支持回溯和重复执行历史表达式。

图形用户界面组件（如采用Tkinter实现）负责创建和管理窗口、按钮、输入框等界面元素。其布局遵循标准计算器设计规范：顶部为显示区域，用于展示当前输入表达式和计算结果；中部为数字键盘区，采用3×4网格排列0-9数字键和小数点；底部为运算符区和功能按钮区，包含加、减、乘、除、等号、清除、删除等按钮。界面组件需要同时响应鼠标点击和键盘输入，确保两种交互方式的行为一致性。此外，界面应支持表达式过长时的自动滚动和结果显示区域的动态调整。

### 2.2 业务逻辑层组件

表达式解析器是整个应用的核心引擎，负责将用户输入的中缀表达式转换为可计算的形式。该组件包含三个子模块：词法分析器负责将输入字符串分解为 tokens（标识符），识别数字、运算符、括号等基本元素；语法分析器负责验证 tokens 序列的语法正确性，检查运算符位置、数字格式、括号匹配等规则；中缀转后缀转换器负责将通过验证的中缀表达式转换为后缀（逆波兰）表示，为后续计算做好准备。解析器应支持快速的前向遍历和回溯机制，能够在检测到错误时精确定位错误位置并提供有意义的错误信息。

计算引擎组件负责执行实际的算术运算。其核心算法基于栈结构的后缀表达式求值：遍历后缀表达式中的每个 token，遇到操作数时压入栈中，遇到运算符时弹出所需数量的操作数进行运算并将结果压回栈中，最终栈顶元素即为计算结果。计算引擎应使用 Decimal 类型处理所有浮点运算，确保计算精度，避免二进制浮点数带来的精度丢失问题。对于除法运算，应检测除数为零的情况并抛出自定义异常。引擎还应实现科学计数法的解析和输出能力，处理极大或极小的数值。

错误处理器组件负责统一管理和分类各类错误情况。应用定义了一套标准的错误类型体系，包括语法错误（SyntaxError）、除零错误（DivisionByZeroError）、括号不匹配错误（ParenthesesMismatchError）、空输入错误（EmptyInputError）和数值溢出错误（NumericOverflowError）。错误处理器接收各模块报告的异常，将其转换为用户友好的中文错误消息，并附加错误位置信息（如"第5个字符附近存在语法错误"），供表现层显示。错误处理器还负责决定哪些错误应阻止计算继续执行，哪些可以给出警告后继续处理。

### 2.3 数据持久层组件

历史记录管理器负责维护用户计算历史的存储和检索。其内部采用环形缓冲区（circular buffer）数据结构，设定最大容量（如50条记录），当记录超出容量时自动覆盖最旧的记录。管理器支持添加记录、获取全部历史、按索引获取单条记录、清除历史等操作。每条历史记录包含原始表达式、计算结果和时间戳。管理器还应支持将历史持久化到本地文件，在应用启动时加载已保存的历史数据，实现跨会话的历史保留功能。历史记录的格式采用结构化存储（如JSON格式），便于解析和扩展。

配置管理器负责管理应用的运行时配置，包括小数精度设置（保留小数位数）、默认主题（深色/浅色，适用于GUI）、历史记录容量上限等。配置信息持久化到独立配置文件（如JSON或YAML格式），应用启动时自动加载用户上次保存的设置。配置管理器提供统一的接口供其他组件读取和修改配置，修改配置时应自动保存到持久存储，确保设置的持久性。

---

## 三、数据流与处理逻辑

### 3.1 表达式处理主流程

用户输入表达式后，数据流经历以下处理阶段。第一阶段为预处理，表现层接收原始字符串，进行首尾空白字符的Trim操作，并将空输入情况交由错误处理器处理。第二阶段为词法分析，表达式解析器的词法分析器逐字符扫描输入字符串，识别并标记各类token（整数、小数、运算符、括号），同时进行基本格式验证（如检测连续的小数点）。第三阶段为语法分析，语法分析器验证token序列的语法正确性，包括检查表达式不以运算符开头或结尾、括号成对出现、无连续运算符等规则。第四阶段为中缀转后缀转换，将通过验证的中缀表达式转换为后缀表示，同时处理运算符优先级和括号嵌套。第五阶段为后缀表达式求值，计算引擎基于栈结构计算最终结果。第六阶段为后处理，将计算结果格式化输出（处理小数精度、科学计数法等），同时触发历史记录更新。

### 3.2 表达式解析详细流程

中缀转后缀转换采用经典的调度场算法（Shunting Yard Algorithm）。初始化一个空运算符栈和一个空输出列表。遍历中缀表达式的每个token：若为操作数，直接添加到输出列表；若为左括号，压入运算符栈；若为右括号，持续弹出运算符栈顶元素到输出列表，直至遇到左括号（左括号不输出）；若为运算符，持续弹出运算符栈顶元素到输出列表，直至栈顶运算符优先级低于当前运算符，然后将当前运算符压入栈中。遍历结束后，将运算符栈中剩余元素全部弹出到输出列表。转换过程中，运算符优先级的设定为：括号最高（但括号不出现在后缀表达式中），乘除次之，加减最低。同级运算符采用左结合性，即从左到右依次计算。

### 3.3 错误检测与传播机制

错误检测贯穿整个处理流程。词法分析阶段检测非法字符（除数字、运算符、括号外的字符）和格式错误（如连续小数点）；语法分析阶段检测括号不匹配（左括号多于右括号或反之）、运算符位置不当（如表达式以运算符开头或结尾、运算符后无操作数）、操作数缺失（如右括号后紧跟运算符）等错误；计算阶段检测除零错误。所有检测到的错误都包装为结构化的错误对象，包含