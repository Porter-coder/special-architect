# 实现计划

## 用户需求
创建一个简单的计算器应用

## 详细计划
# 简单计算器应用实现计划

## 一、总体架构与设计模式

### 1.1 架构概述

本计算器应用采用经典的三层架构模式，将用户界面、业务逻辑层和数据处理层进行清晰分离。这种分层设计确保了各层职责单一，便于维护和扩展，同时支持灵活的组件替换和单元测试。整体架构遵循MVC（模型-视图-控制器）设计模式的核心思想，视图层负责渲染界面和捕获用户输入，控制器层协调用户交互和业务逻辑处理，模型层管理数据存储和核心计算引擎。

应用的核心计算引擎采用栈式数据结构实现表达式解析，支持中缀表达式到后缀表达式的转换算法，确保复杂数学表达式的正确求值。界面层采用响应式设计范式，能够自适应不同屏幕尺寸和分辨率，同时支持深色和浅色主题切换。数据持久化模块采用轻量级存储方案，仅保存必要的配置信息和计算历史记录。

### 1.2 设计模式应用

**策略模式**应用于计算引擎的实现，针对不同类型的运算操作（加、减、乘、除、百分比、平方根等）定义统一的运算接口，使新增运算类型时无需修改现有代码结构。**状态模式**用于管理计算器的各种状态，包括输入状态、运算状态、错误状态等，确保状态转换的清晰可控。**观察者模式**实现界面组件与数据模型之间的联动，当底层数据发生变化时，自动触发界面更新。**命令模式**封装用户操作，将按钮点击和键盘输入统一转换为可执行命令对象，便于实现操作历史记录和撤销重做功能。

### 1.3 技术选型决策

GUI框架选择Python标准库中的Tkinter，其内置于Python解释器中，无需额外安装即可运行，且天然支持跨平台部署。Tkinter提供稳定的原生窗口组件，渲染性能优异，能够满足计算器应用对响应速度的要求。相比PyQt等第三方框架，Tkinter的体积更小、依赖更少，更符合轻量级应用的定位。

数学表达式解析采用改进的调度场算法（Shunting Yard Algorithm），该算法由Edsger Dijkstra提出，经典且可靠，能够正确处理运算符优先级和括号嵌套。算法实现将分为词法分析器、语法分析器和求值器三个子模块，各模块职责明确，利于测试和维护。

---

## 二、关键组件及其职责

### 2.1 视图层组件

**主窗口模块（MainWindow）** 作为应用入口，负责创建和管理主界面框架，协调各子组件的布局和生命周期。主窗口监听系统级事件（如窗口大小变化、主题切换），并将这些事件分发给相应的处理模块。该模块还负责初始化应用配置和加载用户偏好设置。

**显示屏组件（DisplayPanel）** 封装计算器的显示区域，提供内容展示、清空、高亮等基本操作。显示屏支持两种显示模式：表达式模式显示完整的运算过程， result模式聚焦显示当前结果。组件内部维护显示文本的光标位置，支持部分内容选择和复制操作。字体渲染采用自适应策略，根据显示屏尺寸动态调整字号。

**按键面板组件（KeypadPanel）** 以网格布局组织所有按键，提供统一的点击事件处理接口。按键面板支持多种键盘布局变体（标准布局、程序员布局等），通过配置切换。按键组件实现通用的悬停效果、点击反馈和禁用状态管理，确保用户操作的即时视觉反馈。

**历史记录面板（HistoryPanel）** 展示最近的计算记录，支持点击历史条目快速复用表达式。面板采用有限容量的滚动列表，默认保留最近二十条记录，超出容量时自动淘汰最旧条目。用户可选择清空历史或关闭历史记录显示功能。

### 2.2 控制器层组件

**输入控制器（InputController）** 统一处理来自按键面板和键盘的用户输入，维护当前的输入状态（输入数字中、输入完成待运算、连续输入中等）。控制器负责输入内容的合法性检查，包括小数点重复输入、运算符连续输入、超长输入等异常情况的检测和拦截。该组件还实现退格键和清空键的逻辑处理。

**运算协调器（OperationCoordinator）** 作为业务逻辑的核心枢纽，接收输入控制器传递的运算请求，调度计算引擎执行运算，并管理运算结果的显示和状态转换。协调器实现连续运算逻辑，维护隐式的运算数栈，支持用户基于上一次计算结果继续运算。运算过程中的状态变化（如开始新运算、累积运算）由该组件统一管理。

**主题管理器（ThemeManager）** 管理应用的视觉主题，提供深色和浅色两套主题配置。主题切换时，主题管理器遍历所有界面组件，批量应用样式变更。主题配置采用外部文件存储，支持用户自定义颜色方案。系统主题偏好变化时，应用自动切换相应的主题模式。

### 2.3 模型层组件

**表达式解析器（ExpressionParser）** 负责将中缀表达式转换为后缀表达式（逆波兰表示），为求值做好准备。解析器首先进行词法分析，识别数字、运算符、括号等语法单元；随后进行语法分析，检查表达式的语法合法性；最后按照运算符优先级生成后缀表达式序列。解析器处理负号和减号的歧义问题，通过上下文判断负号的含义。

**计算引擎（CalculationEngine）** 接收后缀表达式序列，执行实际的算术运算。引擎内部维护两个操作数栈，遍历后缀表达式时，对于操作数执行压栈操作，对于运算符执行弹出运算和结果压栈操作。引擎实现所有预设的运算函数，包括四则运算、百分比、平方根和符号切换。除法运算检测除零情况，平方根运算验证输入非负性。

**数值管理器（NumberManager）** 封装数值的内部表示和格式化逻辑。内部采用Python的Decimal类型存储数值，确保高精度十进制运算，避免浮点数精度损失。格式化器负责将内部数值转换为显示字符串，支持固定小数位、科学计数法、局部分隔符等多种格式。数值管理器还处理输入约束，如最大长度、小数位数等。

**历史记录存储器（HistoryStore）** 管理计算历史的持久化存储，采用SQLite轻量级数据库或JSON文件存储历史记录。每条历史记录包含原始表达式、计算结果和时间戳。存储器提供添加记录、查询记录、清空历史等接口，支持按表达式内容搜索历史条目。

---

## 三、数据流与处理逻辑

### 3.1 输入处理流程

用户通过按键或键盘输入数据时，输入事件首先传递至输入控制器。输入控制器根据当前输入状态和输入内容类型执行相应处理：若为数字输入且当前处于可输入状态，则将数字追加至当前输入缓冲区；若为运算符输入，则触发当前输入的确认和运算请求；若为控制键（退格、清空），则执行相应的内容修改操作。

输入控制器维护三个核心状态变量：当前输入缓冲区（存储用户正在输入的数值）、上一个操作数（存储已确认的运算数）、当前运算符（存储待执行的运算类型）。状态转换遵循有限状态机模型，定义明确的状态转移条件和动作，确保复杂输入场景下的行为一致性。

输入合法性检查在追加输入前执行，验证规则包括：数字输入时检查是否超过最大长度、小数点后是否已达精度上限；运算符输入时检查是否存在未完成的连续运算符；括号输入时检查括号配对情况。非法输入被静默拒绝，同时触发轻微的视觉反馈（如输入框短暂变色）提示用户。

### 3.2 运算执行流程

当用户完成输入并按下等号或嵌套运算符时，运算协调器启动运算流程。首先，协调器组装完整的数学表达式：将上一个操作数、当前运算符和当前输入缓冲区拼接为标准中缀表达式。处理连续运算场景时，使用上次计算结果替换上一个操作数。

表达式组装完成后，
