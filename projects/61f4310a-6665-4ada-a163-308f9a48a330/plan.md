# 实现计划

## 用户需求
创建一个简单的计算器应用

## 详细计划
# 简单计算器应用技术实现规划书

## 一、总体架构与设计模式

### 1.1 整体架构概述

本计算器应用采用分层架构设计，将用户界面、业务逻辑层、数据持久化层清晰分离。这种架构模式便于各层独立开发和测试，同时确保代码的可维护性和可扩展性。整体架构从上至下分为四层：表现层负责用户交互和界面渲染，业务逻辑层处理所有计算相关的核心算法，数据访问层管理历史记录的存取操作，基础设施层提供跨平台兼容性和系统级功能支持。

表现层采用模型-视图-控制器模式，实现界面与逻辑的解耦。视图组件负责界面元素的呈现和用户输入的捕获，控制器组件协调用户操作与业务逻辑的交互，模型组件承载计算状态和历史数据。这种设计模式使得界面样式的调整不会影响核心计算逻辑，同时也便于后续添加新的交互模式或界面主题。

业务逻辑层采用管道-过滤器模式组织计算流程。用户的输入表达式依次经过词法分析器、语法分析器、语义检查器、AST构建器和表达式计算器，每个处理环节职责单一且可独立测试。这种流水线式的处理方式便于调试和定位问题，也便于后续扩展新的运算符或运算规则。

### 1.2 设计模式应用

策略模式应用于计算引擎的核心算法。不同的运算符处理作为独立策略类实现，通过统一的运算接口进行调用。这种设计使得添加新运算符只需创建新的策略类，无需修改现有计算逻辑，符合开闭原则。同时，精度控制策略也可通过策略模式切换，便于实现普通精度和高精度两种计算模式。

状态模式管理计算器的输入状态。计算器在链式计算模式、表达式编辑模式、结果展示模式等不同状态下的行为有所差异，使用状态模式可以将状态转换逻辑集中管理，避免在各处使用条件判断。状态转换图的设计涵盖所有合法的状态流转路径，确保用户操作的合理性。

观察者模式实现撤销/重做功能与输入历史的同步。每次输入操作发生时，所有注册的观察者都会收到通知，可以独立维护自身的状态副本。这种设计使得撤销/重做功能可以灵活扩展，例如支持多级撤销或操作分组。

单例模式应用于全局配置管理和主题管理器。系统配置、用户偏好设置、当前主题等全局状态通过单例模式访问，确保整个应用中访问的是同一份配置数据。单例的实现采用双重检查锁定模式，在多线程环境下也能正确工作。

工厂模式用于创建不同类型的AST节点和历史记录对象。根据运算符类型和操作数类型，工厂类负责实例化相应的节点对象或记录对象，隐藏了对象创建的复杂逻辑。这种设计便于后续添加新的节点类型或记录类型。

### 1.3 模块划分与依赖关系

计算器应用划分为以下核心模块：界面模块负责所有用户交互界面的呈现和事件处理；表达式解析模块负责将输入字符串转换为抽象语法树；计算引擎模块负责遍历AST并执行计算；历史管理模块负责计算历史的存储和查询；撤销重做模块负责操作历史的缓存和恢复；配置管理模块负责系统设置和用户偏好的存取。

模块间的依赖关系遵循单向依赖原则：界面模块依赖表达式解析和计算引擎获取计算结果；表达式解析模块依赖计算引擎进行表达式验证；历史管理模块和撤销重做模块相对独立，通过事件机制与其他模块通信；配置管理模块作为底层服务被所有模块调用。

## 二、关键组件及其职责

### 2.1 表现层组件

主窗口组件是应用的入口窗口，负责整体界面的布局管理和生命周期控制。主窗口继承自平台原生的顶层窗口类，在Windows平台使用tkinter的Tk或PyQt的QMainWindow，在Linux平台使用对应的GTK或Qt组件。主窗口的职责包括：创建和布局所有子组件、处理窗口关闭事件、管理应用级状态（如当前主题、窗口大小）、协调各子组件的交互。

显示区域组件负责计算表达式和结果的展示。显示区域分为表达式显示区和结果显示区两个部分，采用只读文本编辑框或标签实现。表达式显示区支持水平滚动，当表达式过长时自动滚动至输入焦点位置。结果显示区根据数值大小动态调整字体大小，确保结果完整显示的同时保持最佳可读性。显示区域还负责科学计数法的转换，当数值超出显示宽度时自动切换显示格式。

虚拟键盘组件提供触摸或鼠标操作的输入界面。键盘布局采用标准4×5网格，数字键和基础运算符键占据主要区域，扩展运算符和功能键布置在单独区域或通过切换键访问。键盘组件为每个按键提供视觉反馈，按钮在悬停、按压、禁用等状态下呈现不同的外观样式。键盘布局支持主题切换，深色模式下自动调整按钮颜色和背景色。

### 2.2 业务逻辑层组件

词法分析器负责将输入字符串分解为标记序列。分析器逐字符扫描输入，根据数字格式规则识别数值常量，根据运算符定义识别各类运算符，根据括号规则识别括号标记。词法分析器的输出是标记列表，每个标记包含类型（数值、运算符、括号）和值。分析器还需要处理空白字符（忽略）和非法字符（标记为错误）。

语法分析器负责根据标记序列构建抽象语法树。分析器采用递归下降解析法实现，按照运算符优先级从低到高的顺序处理表达式。解析过程维护一个运算符栈和一个操作数栈，通过移入-归约策略逐步构建AST。语法分析器需要检测常见的语法错误，如连续运算符、括号不匹配、操作数缺失等，并给出精确的错误位置和类型提示。

AST节点类体系定义了语法树的基本结构。基类ExpressionNode定义节点的基本接口，BinaryOpNode表示二元运算符节点包含左右子节点引用，UnaryOpNode表示一元运算符节点包含单个子节点引用，NumberNode表示数值节点包含具体的数值和精度信息。每个节点类都实现evaluate方法，用于计算该节点表示的子表达式的值。

表达式计算器负责遍历AST并计算最终结果。计算器采用后序遍历策略，先计算所有子节点的值，再应用当前节点的运算符计算当前节点的值。计算器处理所有运算符的求值逻辑，包括基本算术运算和扩展运算。计算器还需要处理特殊值情况，如除零错误产生的无穷大、非法运算产生的非数字值等。

### 2.3 数据管理层组件

历史记录管理器负责计算历史的内存管理和持久化。管理器采用环形缓冲区作为内存存储结构，设定最大容量为100条历史记录，当超出容量时自动淘汰最老的记录。管理器提供添加记录、查询记录、删除记录、清空历史等接口方法。持久化采用JSON格式，每次记录变更时同步写入文件，确保数据不丢失。

撤销重做管理器负责操作历史的缓存和状态恢复。管理器维护两个栈结构：撤销栈保存可以撤销的操作状态，重做栈保存可以重做的操作状态。每次用户输入操作时，当前状态被推入撤销栈，同时清空重做栈。撤销操作将状态从撤销栈弹出并推入重做栈，重做操作则反向执行。管理器支持至少10步操作，超出限制时按先进先出原则淘汰历史记录。

配置管理器负责系统设置的存取。配置项包括界面主题（深色/
