# 实现计划

## 用户需求
一个简单的计算器，支持加减乘除运算

## 详细计划
# 计算器应用程序技术实现计划

## 一、整体架构与设计模式

### 1.1 架构概述

本计算器采用分层架构模式设计，将用户界面、业务逻辑和数据管理三个关注点进行清晰分离。整体架构分为四个主要层次：表现层负责命令行交互与用户输入输出；解析层负责表达式的词法分析和语法分析；运算层负责实际的数学计算和结果处理；数据层负责历史记录的管理和状态持久化。这种分层设计确保了各模块之间的低耦合高内聚，便于后续功能扩展和维护。

### 1.2 设计模式应用

程序采用模块化设计模式，每个功能模块作为独立的Python文件存在，通过明确定义的接口进行通信。主程序采用控制反转原则，通过模块导入和函数调用实现流程控制，避免硬编码的依赖关系。历史记录管理采用单例模式确保全局唯一的数据访问点，防止历史记录出现不一致状态。

### 1.3 技术选型依据

鉴于计算器应用的功能复杂度，使用Python标准库即可完整实现全部需求，无需引入第三方依赖。float类型提供足够的精度满足小数点后6位的要求，decimal模块作为备选方案用于处理极端精度场景。标准库的sys模块处理程序退出，os模块处理跨平台兼容性适配，确保在Windows、macOS、Linux三大平台上行为一致。

---

## 二、关键组件及其职责

### 2.1 主程序入口模块（main.py）

主程序模块承担程序生命周期管理和全局协调职责。模块负责初始化运行环境，显示欢迎信息和操作提示，启动主交互循环，接收用户输入并分发至相应处理函数，调用退出命令时清理资源并安全终止程序。主循环采用while True结构持续运行，直至检测到退出信号。

### 2.2 表达式解析模块（parser.py）

表达式解析模块是计算器的核心组件之一，负责将用户输入的字符串转换为可执行的运算指令。模块实现词法分析器功能，识别输入字符串中的数值字面量、运算符和分隔符，将原始字符串拆解为token序列。随后进行语法分析，检查表达式的语法有效性，验证运算符和操作数的排列是否符合四则运算规则，检测括号配对等语法约束。解析结果以抽象语法树或有序token列表形式输出，供运算模块使用。

### 2.3 运算引擎模块（calculator.py）

运算引擎模块实现实际的数学计算逻辑，是程序的功能核心。模块接收解析后的表达式数据，根据运算符类型调用相应的计算函数。计算函数实现加法、减法、乘法、除法四种基本运算，除法运算包含除零检测逻辑。所有运算结果经过精度处理，采用四舍五入法保留6位小数，并执行末尾无效零的自动去除。连续运算模式下，模块维护当前计算结果状态，支持在上一结果基础上继续运算。

### 2.4 历史记录模块（history.py）

历史记录模块负责计算结果的持久化管理，采用固定容量队列实现最近10条记录的存储。模块提供记录添加、查询、清除三个核心接口，新记录插入时若队列已满则自动移除最旧记录。历史记录数据结构包含时间戳、原始表达式、计算结果三个字段，便于用户追溯和查阅。模块实现为单例模式，确保历史数据在程序生命周期内全局唯一。

### 2.5 用户界面模块（ui.py）

用户界面模块封装所有与用户交互相关的功能，包括输入接收、输出显示和信息提示。模块定义标准输入提示符">>> "，实现多语言错误消息的格式化输出，计算结果按规范格式"结果 = [数值]"显示。模块还负责欢迎信息、操作说明、退出确认等辅助信息的展示，确保界面输出的一致性和专业性。

### 2.6 错误处理模块（exceptions.py）

错误处理模块定义程序可能遇到的所有异常类型，形成完整的异常类层次结构。基础异常类捕获通用错误，专用异常类包括输入无效异常、格式错误异常、除零错误异常、数值溢出异常等。每个异常类携带友好的错误消息和可选的错误代码，便于上层模块进行差异化处理。模块还实现全局异常处理器，捕获未预期的异常并转化为用户友好的提示信息。

---

## 三、数据流与处理逻辑

### 3.1 数据流概述

用户输入的数据在程序内部遵循单向流动路径：用户输入 → 用户界面层 → 表达式解析层 → 运算引擎层 → 结果输出。历史记录模块作为旁路组件，在每次计算完成后异步记录结果，不影响主数据流的处理效率。各层之间通过函数参数和返回值传递数据，不共享全局状态，确保数据流动的可追溯性。

### 3.2 输入处理流程

用户输入经历预处理、解析、验证三个阶段。预处理阶段进行首尾空白字符去除、大小写规范化（针对exit/quit命令）；解析阶段将输入字符串拆分为token序列；验证阶段检查token序列的语法有效性，检测缺失操作数、连续运算符、无效字符等错误。验证通过的表达式进入运算阶段，验证失败的表达式触发相应的错误提示。

### 3.3 表达式解析逻辑

表达式解析采用两阶段实现策略。第一阶段进行词法分析，按照运算符和数值模式逐字符扫描输入字符串，数值模式支持整数和小数，小数部分最多6位，负数通过前置减号标识。词法分析输出token列表，每个token包含类型和值两个属性。第二阶段进行语法分析，使用运算符优先级算法处理乘除对加减的优先关系，通过栈结构实现中缀表达式到后缀表达式的转换，便于后续的顺序计算。

### 3.4 运算执行逻辑

后缀表达式求值使用操作数栈作为临时存储空间。从左至右扫描后缀表达式，遇到操作数则压栈，遇到运算符则从栈顶弹出所需数量的操作数进行计算，计算结果压回栈中。表达式扫描完成后，栈顶元素即为最终计算结果。四则运算直接使用Python算术运算符，乘除运算检测除数为零的情况并抛出除零异常。运算结果使用round函数保留6位小数，再通过格式化处理去除末尾无效零。

### 3.5 连续运算处理

连续运算模式维护一个当前结果状态变量，初始值为None。用户输入以等号开头时，使用当前结果作为左操作数进行后续运算。用户输入不含等号时，作为独立表达式计算，计算结果更新当前结果状态。连续运算模式下，当前结果参与后续运算的方式与普通数值相同，同样接受精度处理和格式规范化。

### 3.6 历史记录更新流程

每次计算完成后，系统自动触发历史记录更新流程。首先创建记录对象，包含计算时间、原始表达式、最终结果三个字段。然后调用历史记录模块的添加接口，将新记录插入队列。若队列容量已达上限，添加操作自动触发最旧记录的移除。历史记录在程序退出时无需持久化存储，程序终止后自动清空。

---

## 四、集成点与外部依赖

### 4.1 模块间集成关系

程序各模块通过函数接口进行集成。主程序模块导入并调用表达式解析模块的parse函数、
